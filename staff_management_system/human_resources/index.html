<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Management System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font from Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin-top: 2rem;
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

<div class="container bg-white rounded-xl shadow-lg p-8">
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-800 text-center mb-2">Staff Management System</h1>
        <p class="text-lg text-gray-600 text-center">Manage employees and departments with a simple API interface.</p>
    </header>

    <!-- Control Buttons -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
        <div class="flex space-x-4">
            <button id="add-employee-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                Add Employee
            </button>
            <button id="add-department-btn" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">
                Add Department
            </button>
        </div>
        <!-- Search and Filter Section -->
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 w-full md:w-auto">
            <input type="text" id="search-input" placeholder="Search by name or ID" class="w-full md:w-64 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-300">
            <select id="department-filter" class="w-full md:w-48 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-300">
                <option value="">All Departments</option>
            </select>
        </div>
    </div>
    
    <!-- Employees Table -->
    <div class="overflow-x-auto bg-gray-50 rounded-lg shadow-inner">
        <table id="employees-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-200">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="employees-list" class="bg-white divide-y divide-gray-200">
                <!-- Employee data will be dynamically injected here -->
            </tbody>
        </table>
    </div>

    <!-- Modals for Add/Edit Forms -->
    <!-- Employee Modal -->
    <div id="employee-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 id="employee-modal-title" class="text-xl font-bold mb-4">Add New Employee</h3>
            <form id="employee-form" class="space-y-4">
                <div>
                    <label for="employee-first-name" class="block text-sm font-medium text-gray-700">First Name</label>
                    <input type="text" id="employee-first-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="employee-last-name" class="block text-sm font-medium text-gray-700">Last Name</label>
                    <input type="text" id="employee-last-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="employee-id" class="block text-sm font-medium text-gray-700">Employee ID</label>
                    <input type="number" id="employee-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="employee-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="employee-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="employee-phone" class="block text-sm font-medium text-gray-700">Phone Number (Optional)</label>
                    <input type="tel" id="employee-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="employee-role" class="block text-sm font-medium text-gray-700">Role</label>
                    <input type="text" id="employee-role" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="employee-hire-date" class="block text-sm font-medium text-gray-700">Hire Date</label>
                    <input type="date" id="employee-hire-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="employee-department" class="block text-sm font-medium text-gray-700">Department</label>
                    <select id="employee-department" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                </div>
                <div>
                    <label for="employee-is-active" class="flex items-center space-x-2 text-sm font-medium text-gray-700">
                        <input type="checkbox" id="employee-is-active" checked class="rounded-sm border-gray-300 text-indigo-600 shadow-sm focus:ring-indigo-500">
                        <span>Is Active?</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="close-employee-modal-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition duration-300">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Department Modal -->
    <div id="department-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 id="department-modal-title" class="text-xl font-bold mb-4">Add New Department</h3>
            <form id="department-form" class="space-y-4">
                <div>
                    <label for="department-name" class="block text-sm font-medium text-gray-700">Department Name</label>
                    <input type="text" id="department-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="department-description" class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                    <textarea id="department-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="close-department-modal-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition duration-300">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0 z-50">
        Message goes here.
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const BASE_API_URL = 'http://127.0.0.1:8000/api/';

        // DOM Elements
        const addEmployeeBtn = document.getElementById('add-employee-btn');
        const addDepartmentBtn = document.getElementById('add-department-btn');
        const employeeModal = document.getElementById('employee-modal');
        const departmentModal = document.getElementById('department-modal');
        const closeEmployeeModalBtn = document.getElementById('close-employee-modal-btn');
        const closeDepartmentModalBtn = document.getElementById('close-department-modal-btn');
        const employeeForm = document.getElementById('employee-form');
        const departmentForm = document.getElementById('department-form');
        const employeesList = document.getElementById('employees-list');
        const employeeDepartmentSelect = document.getElementById('employee-department');
        const departmentFilter = document.getElementById('department-filter');
        const searchInput = document.getElementById('search-input');
        const messageBox = document.getElementById('message-box');

        // State
        let employees = [];
        let departments = [];
        let editingEmployeeId = null;
        let editingDepartmentId = null;

        // --- Helper Functions ---
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, duration);
        }

        function showModal(modal) {
            modal.classList.remove('hidden');
        }

        function hideModal(modal) {
            modal.classList.add('hidden');
        }

        function resetForm(form) {
            form.reset();
        }

        // --- Data Fetching and Rendering ---
        async function fetchAllData() {
            try {
                await fetchDepartments();
                await fetchEmployees();
            } catch (error) {
                console.error("Failed to fetch all data:", error);
                // More informative message for the user
                showMessage('Connection error. Please ensure your Django server is running and CORS is configured correctly.', 5000);
            }
        }

        async function fetchEmployees() {
            const response = await fetch(`${BASE_API_URL}employees/`);
            if (!response.ok) throw new Error('Failed to fetch employees');
            const data = await response.json();
            employees = data;
            renderEmployees();
        }

        async function fetchDepartments() {
            const response = await fetch(`${BASE_API_URL}departments/`);
            if (!response.ok) throw new Error('Failed to fetch departments');
            const data = await response.json();
            departments = data;
            renderDepartmentsDropdowns();
        }

        function renderDepartmentsDropdowns() {
            const selectElements = [employeeDepartmentSelect, departmentFilter];
            
            selectElements.forEach(select => {
                const isFilter = select.id === 'department-filter';
                
                // Clear existing options
                while (select.options.length > (isFilter ? 1 : 0)) {
                    select.remove(isFilter ? 1 : 0);
                }
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            });
        }

        function renderEmployees() {
            const searchTerm = searchInput.value.toLowerCase();
            const filterDeptId = departmentFilter.value;

            // Filter employees based on search term and department
            const filteredEmployees = employees.filter(emp => {
                const matchesSearch = (emp.first_name + ' ' + emp.last_name).toLowerCase().includes(searchTerm) ||
                                      String(emp.employee_id).toLowerCase().includes(searchTerm);
                const matchesFilter = !filterDeptId || String(emp.department) === filterDeptId;
                return matchesSearch && matchesFilter;
            });

            employeesList.innerHTML = '';
            if (filteredEmployees.length === 0) {
                employeesList.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No employees found.</td></tr>`;
                return;
            }

            filteredEmployees.forEach(employee => {
                const department = departments.find(dept => dept.id === employee.department);
                const departmentName = department ? department.name : 'N/A';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${employee.first_name} ${employee.last_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${employee.employee_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${employee.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${departmentName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${employee.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button class="text-indigo-600 hover:text-indigo-900 edit-btn" data-id="${employee.id}">Edit</button>
                        <button class="text-red-600 hover:text-red-900 delete-btn" data-id="${employee.id}">Delete</button>
                    </td>
                `;
                employeesList.appendChild(row);
            });
        }

        // --- Event Listeners ---
        addEmployeeBtn.addEventListener('click', () => {
            editingEmployeeId = null;
            document.getElementById('employee-modal-title').textContent = 'Add New Employee';
            resetForm(employeeForm);
            showModal(employeeModal);
        });

        addDepartmentBtn.addEventListener('click', () => {
            editingDepartmentId = null;
            document.getElementById('department-modal-title').textContent = 'Add New Department';
            resetForm(departmentForm);
            showModal(departmentModal);
        });

        closeEmployeeModalBtn.addEventListener('click', () => hideModal(employeeModal));
        closeDepartmentModalBtn.addEventListener('click', () => hideModal(departmentModal));

        // Close modals when clicking outside
        employeeModal.addEventListener('click', (e) => {
            if (e.target.id === 'employee-modal') {
                hideModal(employeeModal);
            }
        });
        departmentModal.addEventListener('click', (e) => {
            if (e.target.id === 'department-modal') {
                hideModal(departmentModal);
            }
        });

        // Search and Filter Handlers
        searchInput.addEventListener('input', renderEmployees);
        departmentFilter.addEventListener('change', renderEmployees);

        // Delegation for Edit/Delete buttons
        employeesList.addEventListener('click', async (e) => {
            const target = e.target;
            const employeeId = target.getAttribute('data-id');
            
            if (target.classList.contains('edit-btn')) {
                const employee = employees.find(emp => String(emp.id) === employeeId);
                if (employee) {
                    editingEmployeeId = employee.id;
                    document.getElementById('employee-modal-title').textContent = 'Edit Employee';
                    // Populate form
                    document.getElementById('employee-first-name').value = employee.first_name;
                    document.getElementById('employee-last-name').value = employee.last_name;
                    document.getElementById('employee-id').value = employee.employee_id;
                    document.getElementById('employee-email').value = employee.email;
                    document.getElementById('employee-phone').value = employee.phone_number || '';
                    document.getElementById('employee-role').value = employee.role;
                    document.getElementById('employee-hire-date').value = employee.hire_date;
                    document.getElementById('employee-department').value = employee.department;
                    document.getElementById('employee-is-active').checked = employee.is_active;

                    showModal(employeeModal);
                }
            } else if (target.classList.contains('delete-btn')) {
                // The 'confirm' dialog is not supported in this environment.
                // We'll proceed directly with a message.
                showMessage('Deleting employee...', 2000);
                await handleDelete(employeeId, 'employees');
            }
        });

        // Department form handling (not currently implemented, but prepared for)
        // You would need to add similar logic for departments if you want to edit/delete them from the UI.
        // For now, only the 'Add' function is implemented for departments.

        // --- Form Submission Handlers ---
        employeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                first_name: form['employee-first-name'].value,
                last_name: form['employee-last-name'].value,
                employee_id: form['employee-id'].value,
                email: form['employee-email'].value,
                phone_number: form['employee-phone'].value || null,
                role: form['employee-role'].value,
                hire_date: form['employee-hire-date'].value,
                is_active: form['employee-is-active'].checked,
                department: parseInt(form['employee-department'].value),
            };

            const method = editingEmployeeId ? 'PUT' : 'POST';
            const url = editingEmployeeId ? `${BASE_API_URL}employees/${editingEmployeeId}/` : `${BASE_API_URL}employees/`;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (!response.ok) throw new Error('Failed to save employee data.');

                hideModal(employeeModal);
                resetForm(employeeForm);
                await fetchEmployees();
                showMessage(`Employee ${editingEmployeeId ? 'updated' : 'added'} successfully!`);
                editingEmployeeId = null;
            } catch (error) {
                console.error("Submission error:", error);
                showMessage(`Error: ${error.message}`);
            }
        });

        departmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                name: form['department-name'].value,
                description: form['department-description'].value,
            };

            const url = `${BASE_API_URL}departments/`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (!response.ok) throw new Error('Failed to save department data.');

                hideModal(departmentModal);
                resetForm(departmentForm);
                await fetchDepartments();
                showMessage('Department added successfully!');
            } catch (error) {
                console.error("Submission error:", error);
                showMessage(`Error: ${error.message}`);
            }
        });
        
        async function handleDelete(id, endpoint) {
            try {
                const response = await fetch(`${BASE_API_URL}${endpoint}/${id}/`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    if (endpoint === 'employees') {
                        await fetchEmployees();
                        showMessage('Employee deleted successfully!');
                    } else if (endpoint === 'departments') {
                        await fetchDepartments();
                        showMessage('Department deleted successfully!');
                    }
                } else {
                    const errorText = await response.text();
                    console.error("Deletion API error:", errorText);
                    throw new Error(`Failed to delete resource. Server says: ${errorText}`);
                }
            } catch (error) {
                console.error("Deletion error:", error);
                showMessage(`Error: ${error.message}`);
            }
        }

        // Initial data load on page load
        fetchAllData();
    });
</script>

</body>
</html>
